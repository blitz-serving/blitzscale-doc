# 4090

## 创建docker容器
使用docker进行构建，将gpu以及网卡设备都添加到容器中，并且使用host网络模式，以便进行多节点间通信
```bash
docker run -itd \
    --privileged \
    --gpus all \
    --ipc host \
    --network host \
    --volume /data2:/nvme \
    --device /dev/infiniband/rdma_cm \
    --device /dev/infiniband/uverbs0 \
    --workdir /root \
    --name blitz-docker \
    nvcr.io/nvidia/pytorch:24.06-py3 /bin/bash
```

## 添加环境变量
添加cmake/bin环境变量
```bash
echo 'export CMAKE_PREFIX_PATH=/root/.local' >> /root/.bashrc
echo 'export PATH=/root/.local/bin:$PATH' >> /root/.bashrc
source /root/.bashrc
```
## 构建grpc依赖
clone grpc的代码,并添加到指定目录
```bash
git clone git@github.com:grpc/grpc.git

git checkout tags/v1.66.0
git submodule update --init --recursive

cd grpc
mkdir -p cmake/build && \
cd cmake/build
cmake \
    -DgRPC_BUILD_TESTS=OFF \
    -DgRPC_INSTALL=ON \
    -DCMAKE_INSTALL_PREFIX=/root/.local \
    ../..
make -j64
make install
```
## 安装所需依赖
``` bash
apt update && \
apt install git vim wget curl autoconf pkg-config libssl-dev -y && \
apt reinstall libibverbs-dev
```

## 安装rust
```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
source "/root/.cargo/env"
```

## clone blitzscale仓库
```bash
git clone git@github.com:blitz-serving/blitz-remake.git
git submodule update --init --recursive
cmake -Bbuild/release -DLOG=info -DBUILD_MODE=release -DTORCH_CUDA_ARCH_LIST=8.0 看下面的
cmake --build build/release -j 64
```

## cmake构建

```bash
cmake -Bbuild/release \
-DTorch_DIR=/usr/local/lib/python3.10/dist-packages/torch \
-DBUILD_MODE=debug \
-DCMAKE_CUDA_ARCHITECTURES=80 \
-DFLASHINFER_CUDA_ARCHITECTURES=80 \
-DTORCH_CUDA_ARCH_LIST='8.0' \
-DFLASHINFER_ENABLE_FP8=false \
-DFLASHINFER_GEN_HEAD_DIMS=128 \
-DFLASHINFER_GEN_MASK_MODES=1 \
-DFLASHINFER_GEN_POS_ENCODING_MODES=1 

cmake --build build/release -j 64
```

## test
```bash
# 通过test_model_llama测试CUDA能够正常使用
./build/bin/test_model_llama
```

## mpi

## nccl
